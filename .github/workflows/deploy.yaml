# Workflow name shown in the GitHub Actions UI
name: Build & Deploy

# Trigger: run this workflow on every push to the main branch
on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    # Use the latest Ubuntu runner (GitHub-hosted)
    runs-on: ubuntu-latest

    # Permissions needed for this workflow
    permissions:
      # Write access to push the updated values.yaml back to the repo
      contents: write
      # Write access to push the Docker image to ghcr.io
      packages: write

    steps:
      # Step 1: Clone the repository into the runner
      - name: Checkout
        uses: actions/checkout@v4

      # Step 2: Log in to GitHub Container Registry (ghcr.io)
      # Uses the automatic GITHUB_TOKEN — no manual secret needed
      - name: Login to ghcr.io
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Step 3: Build the Docker image and push to ghcr.io
      # The tag is the git commit SHA — unique and traceable to the exact code
      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          push: true
          tags: ghcr.io/vitorlfreitas/hello-platform:${{ github.sha }}

      # Step 4: Update the image tag in values.yaml to the new commit SHA
      # This is what ArgoCD will detect and trigger a redeploy
      - name: Update image tag in values.yaml
        run: |
          sed -i "s|tag: .*|tag: ${{ github.sha }}|" charts/hello-platform/values.yaml

      # Step 5: Commit the updated values.yaml and push back to main
      # GitHub Actions' GITHUB_TOKEN does NOT trigger new workflow runs,
      # so this push won't cause an infinite loop
      - name: Commit and push updated values
        run: |
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          git add charts/hello-platform/values.yaml
          git commit -m "ci: update image tag to ${{ github.sha }}"
          git push
